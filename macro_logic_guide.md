# Macro Logic & User Goal Assessment Guide
## Hannah.health Nutrition Personalization System

---

## Table of Contents
1. [Overview](#overview)
2. [Medical Conditions Macro Guidelines](#medical-conditions-macro-guidelines)
3. [Eating Disorder Recovery Approach](#eating-disorder-recovery-approach)
4. [General Fitness & Health Goals](#general-fitness--health-goals)
5. [User Assessment Questionnaire](#user-assessment-questionnaire)
6. [Macro Calculation Algorithms](#macro-calculation-algorithms)
7. [Implementation Strategy](#implementation-strategy)

---

## Overview

Hannah.health uses an adaptive macro distribution system that prioritizes medical needs and recovery while supporting general wellness goals. Our approach is:

- **Medical-first**: NAFLD, diabetes, and other conditions take priority
- **Recovery-sensitive**: ED recovery users can opt out of macro tracking entirely
- **Evidence-based**: All recommendations backed by clinical research
- **Flexible**: Users can adjust based on progress and preferences

---

## Established Standards & Guidelines

### Official Recommendations

#### **Acceptable Macronutrient Distribution Ranges (AMDR)**
*Source: Institute of Medicine/National Academy of Medicine*
```
- Carbohydrates: 45-65% of total calories
- Protein: 10-35% of total calories  
- Fat: 20-35% of total calories
```

#### **Sports Nutrition Guidelines**
*Source: International Society of Sports Nutrition (ISSN)*
```
Protein Requirements:
- General population: 0.8g/kg body weight (RDA)
- Recreational athletes: 1.0-1.4g/kg
- Endurance athletes: 1.2-1.6g/kg
- Strength athletes: 1.6-2.2g/kg
- Maximum useful: ~2.4g/kg

Carbohydrate Requirements:
- Light training: 3-5g/kg body weight
- Moderate (1hr/day): 5-7g/kg
- Heavy (1-3hrs/day): 6-10g/kg
- Ultra-endurance: 8-12g/kg
```

#### **Medical Condition Guidelines**

**American Diabetes Association (2024)**
```
- No ideal macro distribution for all
- Individualize based on metabolic goals
- Focus on quality over percentages
- Typical range: 40-45% carbs for T2D
```

**EASL (European Association for Study of Liver) - NAFLD**
```
- Mediterranean diet pattern recommended
- No specific macro percentages mandated
- Emphasis on food quality
- Moderate carb (40-45%), higher MUFA
```

**American Heart Association**
```
- Carbs: 45-55% (whole grains, fruits, vegetables)
- Protein: 15-20% (plant-based emphasis)
- Fat: 25-35% (limit saturated <6%)
```

---

## Medical Conditions Macro Guidelines

### 1. NAFLD (Non-Alcoholic Fatty Liver Disease)
**Primary Focus: Liver health and fat reduction**

```
Recommended Distribution:
- Carbs: 40-45% (complex, low-GI)
- Protein: 25-30% (lean sources)
- Fat: 25-30% (emphasis on omega-3, limit saturated)

Key Principles:
- Mediterranean diet pattern
- High fiber (25-35g/day)
- Limited added sugars (<10% calories)
- No alcohol
```

### 2. Type 2 Diabetes
**Primary Focus: Blood sugar management**

```
Recommended Distribution:
- Carbs: 35-40% (consistent timing, low-GI)
- Protein: 25-30%
- Fat: 30-35% (healthy fats)

Key Principles:
- Carb counting education
- Consistent meal timing
- Fiber-rich choices
- Portion control
```

### 3. High Cholesterol/Cardiovascular Disease
**Primary Focus: Heart health**

```
Recommended Distribution:
- Carbs: 45-50% (whole grains, fruits, vegetables)
- Protein: 20-25% (plant-based emphasis)
- Fat: 25-30% (unsaturated, limit saturated <7%)

Key Principles:
- DASH diet principles
- Omega-3 rich foods
- Limit sodium (<2300mg)
- High fiber
```

### 4. Hypertension
**Primary Focus: Blood pressure management**

```
Recommended Distribution:
- Carbs: 45-50%
- Protein: 20-25%
- Fat: 25-30%

Key Principles:
- DASH diet protocol
- Sodium restriction (<1500-2300mg)
- Potassium-rich foods
- Limited caffeine
```

### 5. IBS/Digestive Issues
**Primary Focus: Gut health**

```
Recommended Distribution:
- Carbs: 40-45% (low-FODMAP initially)
- Protein: 25-30%
- Fat: 25-30%

Key Principles:
- Elimination/reintroduction phases
- Soluble fiber emphasis
- Adequate hydration
- Meal timing consistency
```

---

## Eating Disorder Recovery Approach

### Core Philosophy
**"All Foods Fit" - Focus on nourishment, not numbers**

### Recovery Stages

#### Stage 1: Initial Recovery (0-3 months)
```
NO MACRO TRACKING
- Hide all numbers
- Focus on regular eating patterns
- 3 meals + 2-3 snacks
- Variety and flexibility emphasized
```

#### Stage 2: Nutritional Rehabilitation (3-6 months)
```
OPTIONAL GENTLE AWARENESS
- Can view food groups (not numbers)
- Balance across food groups
- No restriction
- Honor hunger/fullness
```

#### Stage 3: Maintenance (6+ months)
```
USER CHOICE
- Some may want education on balance
- Others continue without numbers
- Never prescriptive
- Always flexible
```

### Red Flag Features to Avoid
- ❌ Calorie counting
- ❌ Weight tracking
- ❌ "Good/bad" food labels
- ❌ Restriction encouragement
- ❌ Comparison features
- ❌ Before/after photos

---

## General Fitness & Health Goals

### 1. General Health/Maintenance
**For: Overall wellness, disease prevention**

```
Distribution:
- Carbs: 45-50%
- Protein: 20-25%
- Fat: 25-30%

Daily Targets (2000 cal example):
- Carbs: 225-250g
- Protein: 100-125g
- Fat: 55-65g
```

### 2. Weight Loss (Sustainable)
**For: Gradual, healthy weight reduction**

```
Distribution:
- Carbs: 35-40%
- Protein: 30-35%
- Fat: 25-30%

Key Points:
- Moderate deficit (15-20%)
- High protein for satiety
- Adequate carbs for energy
- Focus on whole foods
```

### 3. Muscle Building/Strength
**For: Hypertrophy, strength gains**

```
Distribution:
- Carbs: 40-45%
- Protein: 30-35%
- Fat: 20-25%

Daily Targets (2500 cal example):
- Carbs: 250-280g (40-45%)
- Protein: 190-220g (30-35%)
- Fat: 55-70g (20-25%)

Key Points:
- Protein at 0.7-1g per lb bodyweight
- Adequate carbs for training intensity
- Sufficient fats for hormone production
```

### 4. Endurance Athletics
**For: Runners, cyclists, swimmers**

```
Distribution:
- Carbs: 50-60%
- Protein: 15-20%
- Fat: 20-25%

Key Points:
- High carb for glycogen
- Timing around training
- Adequate recovery nutrition
```

### 5. Power/Explosive Sports
**For: CrossFit, HIIT, sports**

```
Distribution:
- Carbs: 45-50%
- Protein: 25-30%
- Fat: 20-25%

Balance between:
- Quick energy (carbs)
- Recovery (protein)
- Sustained energy (fats)
```

### 6. Active Aging (50+)
**For: Healthy aging, maintaining function**

```
Distribution:
- Carbs: 40-45%
- Protein: 25-30% (higher end)
- Fat: 25-30%

Focus:
- Adequate protein (1.2g/kg)
- Anti-inflammatory foods
- Bone health nutrients
```

### 7. Pregnancy/Postpartum
**For: Maternal and fetal health**

```
Distribution:
- Carbs: 45-50%
- Protein: 20-25%
- Fat: 25-30%

Special Considerations:
- Folate, iron, calcium
- No restrictive dieting
- Adequate calories
- Medical supervision
```

### 8. Vegetarian/Vegan
**For: Plant-based nutrition optimization**

```
Distribution:
- Carbs: 45-55%
- Protein: 15-25%
- Fat: 25-30%

Key Focus:
- Complete proteins
- B12, iron, omega-3
- Variety of sources
```

---

## User Assessment Questionnaire

### Initial Screening (Required)

#### 1. Medical History
```javascript
questions: [
  {
    id: "medical_conditions",
    question: "Do you have any of these medical conditions?",
    type: "multi_select",
    options: [
      "NAFLD/Fatty Liver",
      "Type 1 Diabetes",
      "Type 2 Diabetes", 
      "High Cholesterol",
      "High Blood Pressure",
      "Heart Disease",
      "IBS/Digestive Issues",
      "PCOS",
      "Thyroid Condition",
      "None of the above"
    ],
    priority: "highest"
  },
  {
    id: "eating_history",
    question: "Have you ever struggled with your relationship with food?",
    type: "single_select",
    options: [
      "Currently in ED recovery",
      "Past history of disordered eating",
      "Sometimes feel anxious about food",
      "No concerns"
    ],
    routing: {
      "Currently in ED recovery": "ed_safe_mode",
      "Past history": "gentle_approach"
    }
  }
]
```

#### 2. Mode Selection
```javascript
{
  id: "app_mode",
  question: "How would you like Hannah to support you?",
  type: "single_select",
  options: [
    {
      value: "medical",
      label: "Medical Nutrition",
      description: "Track nutrients important for your health conditions"
    },
    {
      value: "ed_safe",
      label: "Recovery Focus",
      description: "Focus on nourishment without numbers"
    },
    {
      value: "balanced",
      label: "Balanced Wellness",
      description: "General health with flexibility"
    }
  ]
}
```

### Goal Assessment (For Non-ED Users)

#### 3. Primary Goal
```javascript
{
  id: "primary_goal",
  question: "What's your main health goal right now?",
  type: "single_select",
  options: [
    "Manage my medical condition",
    "Improve overall health",
    "Increase energy levels",
    "Build strength/muscle",
    "Improve endurance",
    "Lose weight healthily",
    "Maintain current weight",
    "Support pregnancy/postpartum",
    "Healthy aging"
  ]
}
```

#### 4. Activity Level
```javascript
{
  id: "activity_level",
  question: "How would you describe your typical week?",
  type: "single_select",
  options: [
    {
      value: "sedentary",
      label: "Limited Activity",
      description: "Mostly sitting, minimal exercise"
    },
    {
      value: "lightly_active",
      label: "Light Activity",
      description: "Walking, light exercise 1-3 days/week"
    },
    {
      value: "moderately_active",
      label: "Moderate Activity",
      description: "Exercise 3-5 days/week"
    },
    {
      value: "very_active",
      label: "Very Active",
      description: "Exercise 6-7 days/week"
    },
    {
      value: "extremely_active",
      label: "Athletic Training",
      description: "Intense training, competitive sports"
    }
  ]
}
```

#### 5. Dietary Preferences
```javascript
{
  id: "dietary_style",
  question: "Do you follow any specific eating style?",
  type: "multi_select",
  options: [
    "No restrictions",
    "Vegetarian",
    "Vegan",
    "Mediterranean",
    "Low carb preference",
    "Gluten-free",
    "Dairy-free",
    "Halal",
    "Kosher",
    "Other"
  ]
}
```

#### 6. Experience Level
```javascript
{
  id: "nutrition_experience",
  question: "How familiar are you with nutrition planning?",
  type: "single_select",
  options: [
    "New to this - keep it simple",
    "Some experience - ready to learn",
    "Experienced - I want detailed control"
  ],
  impacts: "complexity_of_recommendations"
}
```

### Optional Deep Dive (For Interested Users)

#### 7. Specific Challenges
```javascript
{
  id: "challenges",
  question: "What makes healthy eating difficult for you?",
  type: "multi_select",
  options: [
    "Limited time for cooking",
    "Budget constraints",
    "Picky eating/food aversions",
    "Emotional eating patterns",
    "Shift work/irregular schedule",
    "Family dietary needs differ",
    "Limited cooking skills",
    "Travel frequently"
  ]
}
```

#### 8. Macro Preference (Advanced Users Only)
```javascript
{
  id: "macro_preference",
  question: "Do you have a macro distribution preference?",
  type: "single_select",
  options: [
    "Let Hannah recommend based on my goals",
    "Balanced approach",
    "Higher protein",
    "Higher carb",
    "Lower carb",
    "Custom (I'll set my own)"
  ]
}
```

---

## Macro Calculation Algorithms

### Base Calculation Steps

#### Step 1: Calculate TDEE (Total Daily Energy Expenditure)
```typescript
interface TDEECalculation {
  bmr: number;
  activityMultiplier: number;
  tdee: number;
  adjustedForGoal: number;
}

function calculateTDEE(user: UserProfile): TDEECalculation {
  // Mifflin-St Jeor Equation
  const bmr = user.sex === 'male' 
    ? (10 * user.weight_kg) + (6.25 * user.height_cm) - (5 * user.age) + 5
    : (10 * user.weight_kg) + (6.25 * user.height_cm) - (5 * user.age) - 161;
  
  const activityMultipliers = {
    sedentary: 1.2,
    lightly_active: 1.375,
    moderately_active: 1.55,
    very_active: 1.725,
    extremely_active: 1.9
  };
  
  const tdee = bmr * activityMultipliers[user.activity_level];
  
  // Goal adjustments
  let adjusted = tdee;
  if (user.goal === 'weight_loss') {
    adjusted = tdee * 0.85; // 15% deficit
  } else if (user.goal === 'muscle_gain') {
    adjusted = tdee * 1.1; // 10% surplus
  }
  
  return { bmr, activityMultiplier, tdee, adjustedForGoal: adjusted };
}
```

#### Step 2: Apply Medical Condition Overrides
```typescript
function applyMedicalOverrides(
  macros: MacroDistribution, 
  conditions: MedicalCondition[]
): MacroDistribution {
  
  // NAFLD takes highest priority
  if (conditions.includes('NAFLD')) {
    return {
      carbs_percent: 42.5,
      protein_percent: 27.5,
      fat_percent: 30,
      fiber_min_g: 30,
      sugar_max_percent: 10,
      saturated_fat_max_percent: 7
    };
  }
  
  // Diabetes second priority
  if (conditions.includes('Type_2_Diabetes')) {
    return {
      carbs_percent: 37.5,
      protein_percent: 27.5,
      fat_percent: 35,
      carb_distribution: 'consistent', // Even throughout day
      fiber_min_g: 25
    };
  }
  
  // Continue for other conditions...
  return macros;
}
```

#### Step 3: Calculate Gram Targets
```typescript
function calculateGramTargets(
  calories: number,
  percentages: MacroDistribution
): MacroGrams {
  return {
    carbs_g: Math.round((calories * percentages.carbs_percent / 100) / 4),
    protein_g: Math.round((calories * percentages.protein_percent / 100) / 4),
    fat_g: Math.round((calories * percentages.fat_percent / 100) / 9),
    fiber_g: percentages.fiber_min_g || 25,
    sugar_g: Math.round((calories * (percentages.sugar_max_percent || 10) / 100) / 4)
  };
}
```

#### Step 4: Meal Distribution
```typescript
function distributeMacrosToMeals(
  dailyMacros: MacroGrams,
  mealPattern: string
): MealMacros {
  const distributions = {
    three_meals: {
      breakfast: 0.3,
      lunch: 0.35,
      dinner: 0.35
    },
    three_meals_two_snacks: {
      breakfast: 0.25,
      morning_snack: 0.1,
      lunch: 0.3,
      afternoon_snack: 0.1,
      dinner: 0.25
    },
    intermittent_fasting: {
      lunch: 0.4,
      snack: 0.2,
      dinner: 0.4
    }
  };
  
  // Apply distribution
  const pattern = distributions[mealPattern];
  return Object.entries(pattern).reduce((meals, [meal, percent]) => {
    meals[meal] = {
      carbs_g: Math.round(dailyMacros.carbs_g * percent),
      protein_g: Math.round(dailyMacros.protein_g * percent),
      fat_g: Math.round(dailyMacros.fat_g * percent)
    };
    return meals;
  }, {});
}
```

### Special Calculations

#### For ED Recovery Mode
```typescript
function calculateEDSafeTargets(user: UserProfile): EDSafeTargets {
  // No numbers shown to user
  // Internal targets for meal planning only
  
  return {
    meals_per_day: 3,
    snacks_per_day: 2-3,
    focus_areas: [
      'variety',
      'regular_eating',
      'honoring_hunger',
      'food_flexibility'
    ],
    hidden_minimums: {
      // Used internally for adequacy checks
      // Never shown to user
      energy_adequate: true,
      variety_score: 'calculate_weekly'
    }
  };
}
```

#### For Athletic Performance
```typescript
function calculateAthleticMacros(
  user: AthleteProfile
): AthleticMacros {
  const baseCalories = calculateTDEE(user).adjustedForGoal;
  
  // Training day adjustments
  const trainingDayCalories = baseCalories * 1.15;
  const restDayCalories = baseCalories * 0.95;
  
  // Nutrient timing
  return {
    training_days: {
      pre_workout: {
        carbs_g: 30-50,
        protein_g: 10-20,
        timing: '1-2 hours before'
      },
      post_workout: {
        carbs_g: 40-60,
        protein_g: 20-30,
        timing: 'within 30 minutes'
      },
      daily_total: calculateGramTargets(trainingDayCalories, {...})
    },
    rest_days: {
      daily_total: calculateGramTargets(restDayCalories, {...})
    }
  };
}
```

---

## Implementation Strategy

### Phase 1: Core Medical Support (Week 1-2)
1. Implement NAFLD macro logic
2. Add diabetes carb distribution
3. Create medical override system
4. Test with sample profiles

### Phase 2: ED-Safe Mode (Week 2-3)
1. Build number-hiding system
2. Create variety tracking
3. Implement meal pattern focus
4. Add recovery-friendly language

### Phase 3: General Fitness (Week 3-4)
1. Add fitness goal calculations
2. Implement activity adjustments
3. Create athletic timing features
4. Add progress tracking

### Database Integration
```sql
-- Add to user_preferences table
ALTER TABLE user_preferences ADD COLUMN macro_preference JSONB DEFAULT '{
  "carbs_percent": null,
  "protein_percent": null,
  "fat_percent": null,
  "calculation_method": "auto",
  "last_updated": null
}';

-- Add goal tracking
CREATE TABLE user_goals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id),
  goal_type TEXT,
  target_macros JSONB,
  target_calories INTEGER,
  start_date DATE,
  end_date DATE,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### API Endpoints
```typescript
// Calculate personalized macros
POST /api/macros/calculate
Body: { goals, conditions, preferences }
Response: { daily_targets, meal_distribution }

// Update macro preferences
PUT /api/users/:id/macro-preferences
Body: { macro_preference }

// Get macro recommendations
GET /api/macros/recommendations/:goal
Response: { recommended_distribution, evidence, tips }
```

### UI Components Needed
1. **Goal Selection Wizard** - Guided questionnaire
2. **Macro Display Widget** - Visual representation (pie chart, bars)
3. **Meal Balance Indicator** - Shows if meals meet targets
4. **Progress Tracker** - Weekly adherence and adjustments
5. **Education Modals** - Explain why certain macros recommended

### Safety Checks
```typescript
function validateMacroTargets(macros: MacroGrams): ValidationResult {
  const errors = [];
  
  // Minimum safety thresholds
  if (macros.protein_g < 0.8 * user.weight_kg) {
    errors.push('Protein too low for health');
  }
  
  if (macros.carbs_g < 130) { // RDA minimum
    errors.push('Carbs below safe minimum');
  }
  
  if (macros.fat_g < 0.25 * user.weight_kg) {
    errors.push('Fat too low for hormone health');
  }
  
  return { valid: errors.length === 0, errors };
}
```

---

## Key Takeaways

1. **Medical conditions always override general fitness goals**
2. **ED recovery mode completely hides macro tracking**
3. **Flexibility is key - users can adjust recommendations**
4. **Education provided but never prescriptive**
5. **Safety checks prevent extreme distributions**
6. **Progressive disclosure - complex features optional**

---

## Final Recommended Macro Presets for Hannah.health

Based on established standards and evidence, here are our refined macro distributions:

```javascript
const macroPresets = {
  // Medical Conditions (Priority)
  medical_nafld: { 
    carbs: 42.5, 
    protein: 27.5, 
    fat: 30,
    label: "NAFLD Management",
    description: "Mediterranean-style for liver health"
  },
  
  medical_diabetes: { 
    carbs: 40, 
    protein: 25, 
    fat: 35,
    label: "Blood Sugar Management",
    description: "Stable glucose control"
  },
  
  // General Health & Fitness
  balanced: { 
    carbs: 45, 
    protein: 25, 
    fat: 30,
    label: "Balanced Nutrition",
    description: "General health maintenance"
  },
  
  fat_loss: { 
    carbs: 35, 
    protein: 35, 
    fat: 30,
    label: "Fat Loss",
    description: "Preserve muscle while losing fat"
  },
  
  strength: { 
    carbs: 42.5, 
    protein: 32.5, 
    fat: 25,
    label: "Muscle Building",
    description: "Support strength training"
  },
  
  endurance: { 
    carbs: 55, 
    protein: 20, 
    fat: 25,
    label: "Endurance Sports",
    description: "Fuel for cardio activities"
  },
  
  lower_carb: { 
    carbs: 30, 
    protein: 35, 
    fat: 35,
    label: "Lower Carb",
    description: "Moderate carb restriction"
  },
  
  // Special Modes
  ed_recovery: { 
    hidden: true,
    label: "Recovery Focus",
    description: "No numbers, focus on nourishment"
  }
};
```

### Why These Distributions?
- All fall within AMDR guidelines (except lower_carb which is slightly below for those who need it)
- Protein never exceeds 35% (unnecessary and potentially harmful)
- Fat stays 20-35% for hormone health
- Carbs adjusted based on activity and medical needs
- Evidence-based and sustainable

## References & Evidence Base

### Primary Sources
- **AMDR**: Institute of Medicine/National Academy of Medicine
- **NAFLD**: EASL-EASD-EASO Clinical Practice Guidelines (2023)
- **Diabetes**: American Diabetes Association Standards of Care (2024)
- **Heart Health**: American Heart Association Scientific Statements
- **Sports Nutrition**: International Society of Sports Nutrition Position Stands
- **ED Recovery**: Academy for Eating Disorders Guidelines
- **General Health**: 2020-2025 Dietary Guidelines for Americans

### Key Research Papers
- Helms et al. (2014): Evidence-based recommendations for natural bodybuilding
- Aragon et al. (2017): International society of sports nutrition position stand: diets and body composition
- Moore et al. (2015): Protein ingestion to stimulate myofibrillar protein synthesis
- Thomas et al. (2016): Position of the Academy: Nutrition and Athletic Performance

---

*Document Version: 1.0*
*Last Updated: January 2025*
*Prepared by: Hannah.health Nutrition Team*